generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model School {
  id                    String                 @id @default(uuid())
  name                  String
  registrationNo        String?                @unique
  type                  SchoolType
  county                String
  subCounty             String?
  ward                  String?
  knecCode              String?                @unique
  kemisCode             String?                @unique
  phone                 String?
  email                 String?
  address               String?
  ownership             Ownership
  boardingStatus        BoardingStatus
  gender                SchoolGender
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  academicYears         AcademicYear[]
  assessmentDefinitions AssessmentDefinition[]
  assessmentResults     AssessmentResult[]
  classes               Class[]
  classSubjects         ClassSubject[]
  streams               Stream[]
  students              Student[]
  studentClasses        StudentClass[]
  subjectOfferings      SubjectOffering[]
  terms                 Term[]
  users                 User[]

  @@index([county])
  @@index([type])
}

model User {
  id         String    @id @default(uuid())
  email      String    @unique
  password   String
  firstName  String
  lastName   String
  middleName String?
  phone      String?
  idNumber   String?   @unique
  role       Role      @default(TEACHER)
  schoolId   String?
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  guardian   Guardian?
  student    Student?
  teacher    Teacher?
  school     School?   @relation(fields: [schoolId], references: [id])

  @@index([role])
  @@index([schoolId])
}

model Student {
  id                String             @id @default(uuid())
  admissionNo       String             @unique
  upiNumber         String?            @unique
  kemisUpi          String?            @unique
  firstName         String
  middleName        String?
  lastName          String
  gender            Gender
  dob               DateTime?
  birthCertNo       String?
  nationality       String             @default("Kenyan")
  county            String?
  subCounty         String?
  hasSpecialNeeds   Boolean            @default(false)
  specialNeedsType  String?
  medicalCondition  String?
  allergies         String?
  schoolId          String?
  userId            String?            @unique
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  assessmentResults AssessmentResult[]
  school            School?            @relation(fields: [schoolId], references: [id])
  user              User?              @relation(fields: [userId], references: [id])
  enrollments       StudentClass[]
  guardians         StudentGuardian[]

  @@index([schoolId])
  @@index([schoolId, admissionNo])
  @@index([schoolId, gender])
}

model Guardian {
  id           String            @id @default(uuid())
  userId       String            @unique
  relationship String
  occupation   String?
  employer     String?
  workPhone    String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  user         User              @relation(fields: [userId], references: [id])
  students     StudentGuardian[]
}

model StudentGuardian {
  id         String   @id @default(uuid())
  studentId  String
  guardianId String
  isPrimary  Boolean  @default(false)
  guardian   Guardian @relation(fields: [guardianId], references: [id], onDelete: Cascade)
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, guardianId])
}

model Teacher {
  id                String             @id @default(uuid())
  userId            String             @unique
  tscNumber         String             @unique
  employeeNumber    String             @unique
  employmentType    EmploymentType
  qualification     String?
  specialization    String?
  dateJoined        DateTime?          @default(now())
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  assessmentsGraded AssessmentResult[] @relation("AssessedBy")
  classTeacherOf    Class[]            @relation("ClassTeacher")
  teachingSubjects  ClassSubject[]     @relation("TeacherClassSubjects")
  streamTeacherOf   Stream[]           @relation("StreamTeacher")
  user              User               @relation(fields: [userId], references: [id])
}

model Sequence {
  id              String   @id @default(uuid())
  key             String   @unique
  type            String
  schoolId        String?
  year            Int?
  currentValue    Int      @default(0)
  prefix          String?
  lastGeneratedAt DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([type])
  @@index([schoolId])
  @@index([year])
  @@index([type, schoolId, year])
}

model AcademicYear {
  id                    String                 @id @default(uuid())
  year                  Int                    @unique
  startDate             DateTime
  endDate               DateTime
  isActive              Boolean                @default(false)
  schoolId              String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  school                School?                @relation(fields: [schoolId], references: [id])
  assessmentDefinitions AssessmentDefinition[]
  classes               Class[]
  classSubjects         ClassSubject[]         @relation("AcademicYearClassSubjects")
  studentClasses        StudentClass[]
  terms                 Term[]

  @@index([isActive])
  @@index([schoolId])
}

model Term {
  id                    String                 @id @default(uuid())
  name                  TermName
  termNumber            Int
  startDate             DateTime
  endDate               DateTime
  academicYearId        String
  schoolId              String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  AssessmentDefinitions AssessmentDefinition[]
  classSubjects         ClassSubject[]         @relation("TermClassSubjects")
  academicYear          AcademicYear           @relation(fields: [academicYearId], references: [id])
  school                School?                @relation(fields: [schoolId], references: [id])

  @@unique([academicYearId, termNumber])
  @@index([academicYearId])
  @@index([academicYearId, schoolId])
  @@index([schoolId])
}

model Class {
  id               String         @id @default(uuid())
  name             String
  level            String
  curriculum       Curriculum
  academicYearId   String
  schoolId         String
  classTeacherId   String?
  pathway          Pathway?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  academicYear     AcademicYear   @relation(fields: [academicYearId], references: [id])
  classTeacher     Teacher?       @relation("ClassTeacher", fields: [classTeacherId], references: [id])
  school           School         @relation(fields: [schoolId], references: [id])
  subjects         ClassSubject[]
  streams          Stream[]
  students         StudentClass[]
  promotedStudents StudentClass[] @relation("Promotion")

  @@unique([name, academicYearId, schoolId])
  @@index([curriculum])
  @@index([schoolId])
  @@index([schoolId, academicYearId])
  @@index([schoolId, level])
}

model Stream {
  id              String         @id @default(uuid())
  name            String
  capacity        Int?
  classId         String
  schoolId        String
  streamTeacherId String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  class           Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  school          School         @relation(fields: [schoolId], references: [id])
  streamTeacher   Teacher?       @relation("StreamTeacher", fields: [streamTeacherId], references: [id])
  students        StudentClass[]
  classSubjects   ClassSubject[]

  @@unique([classId, name])
  @@index([classId])
}

model Subject {
  id           String            @id @default(uuid())
  name         String
  code         String            @unique
  category     SubjectCategory
  learningArea LearningArea?
  subjectGroup SubjectGroup?
  curriculum   Curriculum[]
  description  String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  classLinks   ClassSubject[]
  strands      Strand[]
  offerings    SubjectOffering[]

  @@index([code])
  @@index([category])
}

model SubjectOffering {
  id        String  @id @default(uuid())
  schoolId  String
  subjectId String
  isActive  Boolean @default(true)
  school    School  @relation(fields: [schoolId], references: [id])
  subject   Subject @relation(fields: [subjectId], references: [id])

  @@unique([schoolId, subjectId])
  @@index([schoolId])
}

model ClassSubject {
  id              String                 @id @default(uuid())
  classId         String
  streamId        String?
  subjectId       String
  teacherId       String?
  termId          String
  academicYearId  String
  subjectCategory SubjectCategory
  schoolId        String?
  assessments     AssessmentDefinition[]
  academicYear    AcademicYear           @relation("AcademicYearClassSubjects", fields: [academicYearId], references: [id])
  class           Class                  @relation(fields: [classId], references: [id])
  stream          Stream?                @relation(fields: [streamId], references: [id])
  school          School?                @relation(fields: [schoolId], references: [id])
  subject         Subject                @relation(fields: [subjectId], references: [id])
  teacherProfile  Teacher?                @relation("TeacherClassSubjects", fields: [teacherId], references: [id])
  term            Term                   @relation("TermClassSubjects", fields: [termId], references: [id])
  strands         ClassSubjectStrand[]
  studentClasses   StudentClass[] @relation("StudentClassSubjects")

  @@unique([classId, streamId, subjectId, termId, academicYearId])
  @@index([teacherId])
  @@index([schoolId, academicYearId])
  @@index([schoolId, classId])
  @@index([schoolId, termId])
}

model StudentClass {
  id               String           @id @default(uuid())
  studentId        String
  classId          String
  streamId         String?
  academicYearId   String
  schoolId         String?
  status           EnrollmentStatus @default(ACTIVE)
  classSubjects   ClassSubject[]   @relation("StudentClassSubjects")
  promotedToId     String?
  promotionDate    DateTime?
  transferredFrom  String?
  transferDate     DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  academicYear     AcademicYear     @relation(fields: [academicYearId], references: [id])
  class            Class            @relation(fields: [classId], references: [id])
  promotedTo       Class?           @relation("Promotion", fields: [promotedToId], references: [id])
  school           School?          @relation(fields: [schoolId], references: [id])
  stream           Stream?          @relation(fields: [streamId], references: [id])
  student          Student          @relation(fields: [studentId], references: [id])

  @@index([studentId])
  @@index([classId])
  @@index([status])
  @@index([schoolId, academicYearId])
  @@index([schoolId, classId])
}

model Strand {
  id                    String                 @id @default(uuid())
  name                  String
  description           String?
  subjectId             String
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  assessmentDefinitions AssessmentDefinition[]
  classSubjects         ClassSubjectStrand[]
  subject               Subject                @relation(fields: [subjectId], references: [id])
}

model ClassSubjectStrand {
  id             String       @id @default(uuid())
  classSubjectId String
  strandId       String
  classSubject   ClassSubject @relation(fields: [classSubjectId], references: [id])
  strand         Strand       @relation(fields: [strandId], references: [id])

  @@unique([classSubjectId, strandId])
}

model AssessmentDefinition {
  id             String             @id @default(uuid())
  name           String
  type           AssessmentType
  maxMarks       Float?
  termId         String
  classSubjectId String
  schoolId       String?
  academicYearId String?
  strandId       String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  academicYear   AcademicYear?      @relation(fields: [academicYearId], references: [id])
  classSubject   ClassSubject       @relation(fields: [classSubjectId], references: [id])
  school         School?            @relation(fields: [schoolId], references: [id])
  strand         Strand?            @relation(fields: [strandId], references: [id])
  term           Term               @relation(fields: [termId], references: [id])
  results        AssessmentResult[]

  @@index([schoolId])
  @@index([academicYearId])
  @@index([termId])
  @@index([classSubjectId])
  @@index([strandId])
}

model AssessmentResult {
  id              String               @id @default(uuid())
  studentId       String
  assessmentDefId String
  schoolId        String?
  numericValue    Float?
  grade           String?
  competencyLevel CompetencyLevel?
  comment         String?
  assessedById    String
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  assessedBy      Teacher              @relation("AssessedBy", fields: [assessedById], references: [id])
  assessmentDef   AssessmentDefinition @relation(fields: [assessmentDefId], references: [id])
  school          School?              @relation(fields: [schoolId], references: [id])
  student         Student              @relation(fields: [studentId], references: [id])

  @@unique([studentId, assessmentDefId])
  @@index([schoolId])
  @@index([studentId])
  @@index([assessmentDefId])
  @@index([assessedById])
}

enum SchoolType {
  PRIMARY
  SECONDARY
  TVET
  SPECIAL_NEEDS
  PRE_PRIMARY
}

enum Ownership {
  PUBLIC
  PRIVATE
  FAITH_BASED
  NGO
}

enum BoardingStatus {
  DAY
  BOARDING
  BOTH
}

enum SchoolGender {
  BOYS
  GIRLS
  MIXED
}

enum Role {
  SUPER_ADMIN
  ADMIN
  TEACHER
  STUDENT
  PARENT
  SUPPORT_STAFF
}

enum Gender {
  MALE
  FEMALE
}

enum EmploymentType {
  PERMANENT
  CONTRACT
  TEMPORARY
  BOM
  PTA
}

enum TermName {
  TERM_1
  TERM_2
  TERM_3
}

enum Curriculum {
  CBC
  EIGHT_FOUR_FOUR
  TVET
  IGCSE
  IB
}

enum Pathway {
  STEM
  ARTS_SPORTS
  SOCIAL_SCIENCES
}

enum SubjectCategory {
  CORE
  ELECTIVE
  OPTIONAL
  TECHNICAL
  APPLIED
}

enum LearningArea {
  LANGUAGES
  MATHEMATICS
  SCIENCE_TECHNOLOGY
  SOCIAL_STUDIES
  RELIGIOUS_EDUCATION
  CREATIVE_ARTS
  PHYSICAL_HEALTH_EDUCATION
  PRE_TECHNICAL_STUDIES
}

enum SubjectGroup {
  LANGUAGES
  SCIENCES
  HUMANITIES
  TECHNICAL_APPLIED
  BUSINESS_STUDIES
}

enum EnrollmentStatus {
  ACTIVE
  PROMOTED
  TRANSFERRED
  GRADUATED
  DROPPED_OUT
  SUSPENDED
}

enum AssessmentType {
  CAT
  MIDTERM
  END_OF_TERM
  MOCK
  NATIONAL_EXAM
  COMPETENCY_BASED
}

enum CompetencyLevel {
  EXCEEDING_EXPECTATIONS
  MEETING_EXPECTATIONS
  APPROACHING_EXPECTATIONS
  BELOW_EXPECTATIONS
}
